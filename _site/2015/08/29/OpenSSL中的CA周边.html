<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>OpenSSL中的CA周边（三）</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "http://hm.baidu.com/hm.js?23ca870ecf6126f172d4f8539b0a593a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">RootKiter</a></h1>
          </div>

          <h2>OpenSSL中的CA周边（三）
</h2>
<!--
<audio controls=true autoplay="true">
  <source src="http://rootkiter.rootkiter.com/music/">
</audio>
-->

<p class="meta">29 Aug 2015</p>

<div class="post">
<h2>前言</h2>

<p>最近在读OpenSSL的命令参数，在这个学习过程中发现OpenSSL之中，架构了一个非常庞大的理论系统，结果原以为学习一两天就能学完的基础知识，整整学了两个星期，才学到一些皮毛。</p>

<p>之前整理了一些OpenSSL相关的学习笔记，这篇将涉及一些OpenSSL中和CA有关的知识。  </p>

<h2>架设CA服务器</h2>

<p>OpenSSL提供了CA指令用于CA服务器的模拟，这个模拟环境能够可以模拟证书的签发吊销等常见CA的操作。CA服务器的目录结构相对复杂，如下所示：</p>

<p><img src="http://rootkiter.com/images/2015_08_30_00_02/1.png" alt="rootkiter.com"> </p>

<p>为便于测试人员使用，OpenSSL提供了一个perl脚本（/usr/lib/ssl/misc/CA.pl），以便自动生成CA的环境目录，命令序列如下所示：<br>
<cmd>
$ mkdir CA/ &amp;&amp; cd CA/<br>
$ cp /usr/lib/ssl/misc/CA.pl ./<br>
$ ./CA.pl -newca<br>
</cmd></p>

<p>命令执行后，环境中会自动生成一个自签名的CA根证书(demoCA/cacert.pem)，以及对应的私钥文件(demoCA/private/cakey.pem)。<br>
可以使用x509和rsa 两个指令查看相应文件的内容。指令如下所示：<br>
<cmd>
$ openssl x509 -in demoCA/cacert.pem -text -noout<br>
$ openssl rsa -in demoCA/private/cakey.pem -passin pass:12345678 -text –noout<br>
</cmd></p>

<p>相关字段的具体含义请参考《<a href="http://rootkiter.com/2015/08/25/%E4%BB%8E%E7%99%BE%E5%BA%A6%E8%AF%81%E4%B9%A6%E5%BC%80%E5%A7%8B.html">从百度证书开始</a>》和《<a href="http://rootkiter.com/2015/08/27/OpenSSL%E4%B8%AD%E7%9A%84%E9%9D%9E%E5%AF%B9%E7%A7%B0%E7%AE%97%E6%B3%95.html">OpenSSL中的非对称算法</a>》两篇学习笔记中的介绍。</p>

<h2>生成证书请求</h2>

<p>CA签发证书前，要对客户的证书请求进行验证（除了对文件的内容进行验证以外，更多的其实是申请流程的认证，提交各种不同种类的证明材料），当验证无误后才会进行证书的颁发。所以证书请求一般由客户方提出，下面分别介绍下不同种类的证书请求生成方法.</p>

<h3>生成RSA证书请求</h3>

<h4>直接生成</h4>

<p>在创建rsa密钥的同时生成证书请求，指令格式如下：<br>
<cmd>
$ openssl req -new -newkey rsa:1024 -keyout privkey.pem -passout pass:12345678 -out req.pem
</cmd></p>

<p>查看证书请求中的内容，指令格式如下：<br>
<cmd>
$ openssl req -in req.pem -text -noout
</cmd></p>

<p><img src="http://rootkiter.com/images/2015_08_30_00_02/2.png" alt="rootkiter.com"> </p>

<p>可以看到证书请求文件中包含公钥以及证书所属者的字段，下方的Signature Algorithm字段为自己的私钥的签名值，可确保证书请求的真实性。</p>

<h4>从RSA密钥生成</h4>

<p>有些时候客户手中已经握有密钥，且希望从已有的密钥生成证书请求。指令如下所示：<br>
<cmd>
$ openssl req -new -key rsaprivkey.pem -out req.pem
</cmd></p>

<p>在openssl的交互提示下录入必要的申请者信息即可。此时生成的请求文件同直接生成的请求结构大体相同，如下所示：<br>
<cmd>
$ openssl req -in req.pem -text -noout
</cmd></p>

<p><img src="http://rootkiter.com/images/2015_08_30_00_02/3.png" alt="rootkiter.com"> </p>

<h3>生成DSA证书请求</h3>

<h4>直接生成</h4>

<p>由于dsa密钥的生成需要有一个dsa参数文件， dsa参数文件的生成可以使用以下命令：<br>
<cmd>
$ openssl dsaparam -out dsaparam.pem 1024
</cmd></p>

<p>在创建dsa密钥的同时生成证书请求，指令格式如下：<br>
<cmd>
$ openssl req -new -newkey dsa:dsaparam.pem -keyout dsakey.pem -out req.pem -passout pass:12345678
</cmd></p>

<p>查看证书请求中的内容，指令如下所示：<br>
<cmd>
$ openssl req -in req.pem -text -noout
</cmd></p>

<p>DSA的证书请求看起来似乎复杂一些，但多出来的内容也只是dsa公钥的相关参数，所以单从请求结构上看还是相同的。</p>

<p><img src="http://rootkiter.com/images/2015_08_30_00_02/4.png" alt="rootkiter.com"> </p>

<h4>从DSA密钥生成</h4>

<p>有些时候客户手中已经握有密钥，且希望从已有的密钥生成证书请求。指令如下所示：<br>
<cmd>
$ openssl req -new -key dsa512_1.key -out req.pem
</cmd></p>

<p>在openssl的交互提示下录入必要的申请者信息即可。此时生成的请求文件同直接生成的请求结构大体相同，如下所示：<br>
<cmd>
$ openssl req -in req.pem -text -noout
</cmd></p>

<p><img src="http://rootkiter.com/images/2015_08_30_00_02/5.png" alt="rootkiter.com"> </p>

<h2>CA操作</h2>

<h3>签发一个证书</h3>

<p>CA收到证书请求后，会对客户提供的各种证明资料进行审核，审核通过后会进行证书颁发工作，证书的颁发指令格式如下所示：<br>
<cmd>
rootkiter@PC:~/CA$ openssl ca -in ~/RSA/req.pem -out ~/RSA/cert.cer -notext
</cmd></p>

<p>此时，cert.cer就是颁发完成的证书了。可以通过x509指令进行内容查看，指令如下所示：</p>

<p><img src="http://rootkiter.com/images/2015_08_30_00_02/6.png" alt="rootkiter.com"> </p>

<h3>批量签署证书请求</h3>

<p>在“生成证书请求”的章节，已经生成了多个种类的证书，可以将这些证书放到一个目录下，进行批量签署，如下所示：</p>

<p><img src="http://rootkiter.com/images/2015_08_30_00_02/7.png" alt="rootkiter.com"> </p>

<p>批量签署命令格式如下所示：<br>
<cmd>
$ openssl ca -notext -infiles ~/reqs_file/careq_dsa_req.pem ~/reqs_file/careq_rsa_req.pem ~/reqs_file/dsa_req.pem
</cmd></p>

<h3>查看CA签署过的证书</h3>

<p>demoCA目录下有个index文件，该文件记录着该CA签署过的证书内容，可以通过cat指令查看，如下所示：<br>
<cmd>
$ cat demoCA/index.txt
</cmd></p>

<p><img src="http://rootkiter.com/images/2015_08_30_00_02/8.png" alt="rootkiter.com"> </p>

<p>其中第三列为证书的序列号内容，在ca指令的 status选项下，可以通过指定这个序列号，来查看这个证书当前的状态，指令如下所示：<br>
<cmd>
rootkiter@PC:~/CA$ openssl ca -status FE2B37D676F58905
</cmd></p>

<p><img src="http://rootkiter.com/images/2015_08_30_00_02/9.png" alt="rootkiter.com"> </p>

<h3>证书吊销</h3>

<p>当客户的密钥出现问题后（被窃取或者丢失），需要进行证书吊销，吊销指令如下所示：<br>
<cmd>
$ openssl ca -revoke ~/RSA/cert.cer -crl_reason keyCompromise
</cmd></p>

<p>吊销后在查看该证书，可以发现其已经吊销成功，如下图所示：  </p>

<p><img src="http://rootkiter.com/images/2015_08_30_00_02/10.png" alt="rootkiter.com"> </p>

<h3>生成吊销列表</h3>

<p>为了方便公众查询证书的吊销状态，ca指令提供了生成吊销列表的指令，格式如下所示：<br>
<cmd>
$ openssl ca -gencrl -crldays 7 -crlhours 7 -out crl.crl
</cmd></p>

<p>可以通过 crl指令查看吊销列表内容，指令格式如下所示：<br>
<cmd>
$ openssl ca -crl -in crl.crl -text -noout
</cmd></p>

<p><img src="http://rootkiter.com/images/2015_08_30_00_02/11.png" alt="rootkiter.com"> </p>

<h2>证书验签</h2>

<p>证书验签方法可以参考《<a href="http://rootkiter.com/2015/08/25/%E4%BB%8E%E7%99%BE%E5%BA%A6%E8%AF%81%E4%B9%A6%E5%BC%80%E5%A7%8B.html">从百度证书开始</a>》笔记中的相关内容。</p>

<h2>总结</h2>

<p>这篇学习笔记记录了OpenSSL中和CA相关的一些操作指令，以及背景知识。</p>

</div>


          <div class="footer">
            <div class="contact">
              <p>
                链接 1：<br />
                链接 2：<br />
              </p>
            </div>
            <div class="contact">
              <p>
                <a href="http://rootkiter.com/atom.xml"> RSS 源 </a><br />
                <a href="http://rootkiter.com/EarthWorm"> EarthWorm 主页</a><br />
              </p>
            </div>
          </div>
<!--
        <a href="/friend_links.html" style="float:right">友链在此，想看就看</a>
-->
        </div>
    </body>
</html>
