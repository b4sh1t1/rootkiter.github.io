<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>借力打力－smali代码窃取</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "http://hm.baidu.com/hm.js?7bf4580b913f88aacb1065688fea0758";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">RootKiter</a></h1>
          </div>

          <h2>借力打力－smali代码窃取
</h2>
<!--
<audio controls=true autoplay="true">
  <source src="http://rootkiter.rootkiter.com/music/">
</audio>
-->

<p class="meta">08 May 2015</p>

<div class="post">
<h1>起因</h1>

<p>这两天在分析一个apk样本，在分析中遇到了一个硬编码密文字符串的情况。
下图就是样本中的一个硬编码密文：<br>
<img src="http://rootkiter.com/images/2015_05_08_20_00/2_1.png" alt="rootkiter.com"> </p>

<p>其对应的解码函数为：<br>
<img src="http://rootkiter.com/images/2015_05_08_20_00/2_2.png" alt="rootkiter.com">  </p>

<p>要想确定上面的硬编码字符串经isInstallation这个函数还原后的原始结果，有三种思路：  </p>

<p>1.动态调试，调试到解密位置，看寄存器的结果。<br>
2.重打包，在解密后的位置加段打日志的代码，然后重打包运行，就能在日志中看到解密结果了。<br>
3.代码窃取，它的主体思路是：将解密函数（isInstallation）的smali代码抠出来，然后我们自己写一段代码去掉用这个解密函数。  </p>

<p>其实头两种是比较常见的做法，可惜这个样本有反调试机制，而且dex文件中有一段代码又是通过so文件动态还原的，导致头两种方法都很难有效。于是只能用最后一种方法。</p>

<h1>操作步骤</h1>

<p>首先按照isInstallation的定义格式（这里方法定义为公有或者私有不用较真，能调用就行），写一个段java框架代码，如下所示：<br>
<img src="http://rootkiter.com/images/2015_05_08_20_00/2_3.png" alt="rootkiter.com"> </p>

<p>保存运行，试一下这段代码是否有错误：
<img src="http://rootkiter.com/images/2015_05_08_20_00/2_4.png" alt="rootkiter.com">  </p>

<p>将字节码文件（.class）转化成dex文件，命令为：<br>
<cmd>
$ dx --dex --output=classes.dex HelloWorld.class
</cmd>
<img src="http://rootkiter.com/images/2015_05_08_20_00/2_5.png" alt="rootkiter.com">  </p>

<p>再将dex文件反编译成 smali文件，命令为：<br>
<cmd>
$ java -jar baksmali.jar -o aaa/ classes.dex
</cmd>
<img src="http://rootkiter.com/images/2015_05_08_20_00/2_6.png" alt="rootkiter.com">  </p>

<p>去样本中将isInstallation反编译的代码结果覆盖到 aaa/HelloWorld.smali 的相应代码中：</p>

<p><img src="http://rootkiter.com/images/2015_05_08_20_00/2_7.png" alt="rootkiter.com">  </p>

<p>保存退出后，将这个smali代码编译为dex文件,命令为：<br>
<cmd>
$ java -jar smali.jar -o classes.dex  aaa/HelloWorld.smali
</cmd><br>
<img src="http://rootkiter.com/images/2015_05_08_20_00/2_8.png" alt="rootkiter.com">  </p>

<p>此时将生成的dex文件上传到手机等待调用。<br>
<img src="http://rootkiter.com/images/2015_05_08_20_00/2_9.png" alt="rootkiter.com"><br>
最后将要解密的字符串传到这个程序中就能解密对应字符串了，命令如下所示：<br>
<cmd>
# dalvikvm -cp /data/local/HelloWorld.zip HelloWorld Q=6/pbCypY64tfHs8UFBpZfETzsr
</cmd>
<img src="http://rootkiter.com/images/2015_05_08_20_00/2_10.png" alt="rootkiter.com">  </p>

<p>这时输出的 “contact_id = ” 就是 ”Q=6/pbCypY64tfHs8UFBpZfETzsr” 这个字符串解密的结果了。</p>

</div>


          <div class="footer">
            <div class="contact">
              <p>
                链接 1：<br />
                链接 2：<br />
              </p>
            </div>
            <div class="contact">
              <p>
                <a href="http://rootkiter.com/atom.xml"> RSS 源 </a><br />
                <a href="http://rootkiter.com/EarthWorm"> EarthWorm 主页</a><br />
              </p>
            </div>
          </div>
        <a href="/friend_links.html" style="float:right">友链在此，想看就看</a>
        </div>
    </body>
</html>
